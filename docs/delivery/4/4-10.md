# [4-10] E2E CoS Test - Verify voice-enabled frontend

[Back to task list](./tasks.md)

## Description

Perform comprehensive end-to-end testing to verify all acceptance criteria from PBI 4 are met. Test the complete voice-enabled workflow on target devices (iOS Safari, Android Chrome) and validate all conditions of satisfaction.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-12 00:00:00 | Created | N/A | Proposed | Task file created | Sean |

## Requirements

Verify all acceptance criteria from PBI 4 PRD:

### Core Functionality
- [ ] Next.js app builds and runs successfully
- [ ] App detects Web Speech API support on load
- [ ] Push-to-talk button starts recording on press
- [ ] Speech recognition captures audio continuously while held
- [ ] Transcript updates in real-time as user speaks
- [ ] Button release stops recording and sends question
- [ ] API client creates session on app load
- [ ] Question is sent to backend with session_id
- [ ] Response is displayed in text area
- [ ] Response is automatically spoken via TTS

### User Interactions
- [ ] User can tap to stop TTS mid-sentence
- [ ] Heartbeat is sent every 30 seconds
- [ ] Session is recreated if backend connection fails
- [ ] Fallback text input shown if speech not supported
- [ ] Button is large enough for eyes-free interaction (200x200px)
- [ ] App works on iOS Safari and Android Chrome
- [ ] Visual states clearly indicate system status
- [ ] Conversation history is preserved during session

### Mobile Optimizations
- [ ] App prevents zoom on button interactions
- [ ] Loading states show clear feedback
- [ ] Error messages are clear and actionable

## Test Plan

### 1. Build and Deployment Test

```bash
# Test Next.js build
cd /home/sean/workspace/janus/web
pnpm build

# Verify build output
ls -la out/
test -f out/index.html || echo "FAIL: index.html not found"
test -f out/manifest.json || echo "FAIL: manifest.json not found"

# Test Go backend serves static files
cd ../api
go build -o bin/server cmd/server/main.go
./bin/server &
SERVER_PID=$!

# Wait for server to start
sleep 2

# Test endpoints
curl http://localhost:3000/ | grep -q "Janus" || echo "FAIL: Frontend not served"
curl http://localhost:3000/manifest.json | grep -q "Janus" || echo "FAIL: Manifest not served"
curl http://localhost:3000/api/health | grep -q "ok" || echo "FAIL: API health check failed"

# Cleanup
kill $SERVER_PID
```

### 2. Browser Compatibility Test

**Chrome/Edge (Desktop)**:
- [ ] Open http://localhost:3000
- [ ] Verify app loads without errors
- [ ] Check console for warnings/errors
- [ ] Verify Web Speech API detected
- [ ] Test complete voice flow
- [ ] Verify TTS auto-plays

**iOS Safari**:
- [ ] Access via Tailscale from iPhone
- [ ] Grant microphone permission
- [ ] Test voice recognition (webkit prefix)
- [ ] Verify button size adequate for thumb
- [ ] Test orientation changes
- [ ] Verify TTS works
- [ ] Test add-to-home-screen

**Android Chrome**:
- [ ] Access via Tailscale from Android
- [ ] Grant microphone permission
- [ ] Test voice recognition
- [ ] Verify button size
- [ ] Test back button behavior
- [ ] Verify TTS works

**Firefox (Fallback)**:
- [ ] Open app
- [ ] Verify text input fallback appears
- [ ] Verify can still ask questions
- [ ] Verify response text displayed
- [ ] Verify TTS still works (if supported)

### 3. Voice Recognition Test Scenarios

**Scenario 1: Short Question**:
1. Press and hold button
2. Say: "What is the purpose of this project?"
3. Verify interim transcript appears
4. Release button
5. Verify final transcript correct
6. Verify question sent to backend
7. Verify response received
8. Verify TTS plays response

**Scenario 2: Long Rambling Question**:
1. Press and hold button
2. Speak for 30+ seconds continuously
3. Verify recognition doesn't timeout
4. Verify transcript continues updating
5. Release button
6. Verify complete transcript captured
7. Verify sent to backend

**Scenario 3: Multiple Questions**:
1. Ask 5 questions in succession
2. Verify each is processed correctly
3. Verify conversation history builds
4. Verify no memory leaks
5. Verify session remains active

### 4. Error Handling Test Scenarios

**Scenario 1: Permission Denied**:
1. Block microphone permission
2. Try to use voice
3. Verify error message shown
4. Verify fallback offered
5. Grant permission
6. Verify recovery

**Scenario 2: Network Failure**:
1. Start asking question
2. Disconnect network mid-request
3. Verify error shown
4. Verify retry option
5. Reconnect network
6. Verify retry succeeds

**Scenario 3: Session Timeout**:
1. Start session
2. Wait 11 minutes (no interaction)
3. Try to ask question
4. Verify new session created automatically
5. Verify question succeeds

**Scenario 4: Backend Restart**:
1. Ask question successfully
2. Restart backend server
3. Wait for connection lost
4. Verify reconnection UI
5. Verify new session created
6. Ask question
7. Verify works

### 5. Mobile UX Test Scenarios

**Scenario 1: Eyes-Free Operation**:
1. On mobile device
2. Without looking at screen
3. Press button by feel
4. Speak question
5. Release button
6. Listen to response
7. Verify complete flow works without visual feedback

**Scenario 2: Driving Simulation**:
1. Have someone else hold phone
2. You focus on "driving" (looking away)
3. Ask several questions
4. Verify can interact safely
5. Verify button size adequate
6. Verify audio feedback sufficient

**Scenario 3: Outdoor Bright Sun**:
1. Take device outside
2. Verify screen readable
3. Verify high contrast works
4. Verify can see button states

**Scenario 4: Interruptions**:
1. Start asking question
2. Receive phone call
3. Verify app pauses gracefully
4. Return to app
5. Verify can continue

### 6. Session Management Test

```bash
# Test heartbeat
# Open browser DevTools > Network
# Start session
# Wait and observe heartbeat requests every 30 seconds
# Verify: POST /api/heartbeat?session_id=...

# Test session persistence
# Ask question
# Wait 5 minutes
# Ask another question
# Verify: Same session ID used
# Verify: Conversation history preserved

# Test session recovery
# Note session ID
# Stop backend
# Wait 90 seconds (3 failed heartbeats)
# Start backend
# Verify: New session created
# Verify: UI shows reconnected
# Ask question
# Verify: Works with new session
```

### 7. Performance Test

- [ ] Initial load < 2 seconds
- [ ] Button press response < 100ms
- [ ] API response < 5 seconds (typical)
- [ ] TTS starts < 500ms after response
- [ ] No UI jank during animations
- [ ] Memory stable over 20+ questions
- [ ] No console errors

### 8. Accessibility Test

- [ ] Button has proper ARIA labels
- [ ] Focus states are visible
- [ ] Color contrast meets WCAG AA
- [ ] Works with screen reader (bonus)
- [ ] Touch targets ≥ 44x44px
- [ ] Text is readable (16px+ on mobile)

## Success Criteria

All acceptance criteria from PBI 4 must pass:
- ✅ All 21 criteria from PRD verified
- ✅ Works on iOS Safari and Android Chrome
- ✅ Fallback works in unsupported browsers
- ✅ No critical bugs found
- ✅ Performance meets targets
- ✅ Mobile UX is safe for driving

## Verification Script

```bash
#!/bin/bash
# E2E verification script

echo "=== PBI 4 E2E Verification ==="

# Start backend
cd /home/sean/workspace/janus/api
go run cmd/server/main.go &
SERVER_PID=$!
sleep 3

echo "✓ Backend started (PID: $SERVER_PID)"

# Check health
curl -s http://localhost:3000/api/health | grep -q '"status":"ok"'
if [ $? -eq 0 ]; then
  echo "✓ Backend health check passed"
else
  echo "✗ Backend health check failed"
  kill $SERVER_PID
  exit 1
fi

# Check frontend
curl -s http://localhost:3000/ | grep -q "Janus"
if [ $? -eq 0 ]; then
  echo "✓ Frontend loads"
else
  echo "✗ Frontend failed to load"
  kill $SERVER_PID
  exit 1
fi

# Check manifest
curl -s http://localhost:3000/manifest.json | grep -q "Janus"
if [ $? -eq 0 ]; then
  echo "✓ PWA manifest accessible"
else
  echo "✗ PWA manifest not found"
  kill $SERVER_PID
  exit 1
fi

echo ""
echo "=== Automated checks passed ==="
echo "=== Manual testing required ==="
echo ""
echo "1. Open http://localhost:3000 in Chrome"
echo "2. Open http://YOUR-TAILSCALE-IP:3000 on mobile"
echo "3. Run through manual test scenarios above"
echo "4. Mark all acceptance criteria as verified"
echo ""
echo "Press CTRL+C when done to stop server"

# Wait for user to finish manual testing
wait $SERVER_PID
```

## Files Modified

### New Files
- `docs/delivery/4/e2e-verification.sh` - Automated verification script
- `docs/delivery/4/test-results.md` - Test results documentation

### Modified Files
None (testing only)

## Test Results Template

```markdown
# PBI 4 E2E Test Results

**Date**: YYYY-MM-DD
**Tester**: [Name]
**Environment**: [Production/Development]

## Automated Tests
- [ ] Build successful
- [ ] Backend serves frontend
- [ ] API endpoints functional

## Browser Compatibility
- [ ] Chrome Desktop
- [ ] iOS Safari
- [ ] Android Chrome
- [ ] Firefox (fallback)

## Acceptance Criteria
[Copy all 21 criteria and mark as passed/failed]

## Issues Found
1. [Issue description]
   - Severity: [Critical/High/Medium/Low]
   - Status: [Open/Fixed]

## Performance Metrics
- Load time: X seconds
- Button response: X ms
- API latency: X ms

## Sign-off
- [ ] All critical tests passed
- [ ] All acceptance criteria met
- [ ] Ready for production
```


