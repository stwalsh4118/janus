# [4-8] Integration and end-to-end flow testing

[Back to task list](./tasks.md)

## Description

Integrate all components built in previous tasks into a cohesive whole, test the complete user flow from session start to conversation, and fix any integration issues that arise from component interactions.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-12 00:00:00 | Created | N/A | Proposed | Task file created | Sean |

## Requirements

1. Ensure all components work together:
   - API client ‚Üí Session manager ‚Üí UI state
   - Speech recognition ‚Üí Transcript ‚Üí API call ‚Üí TTS
   - Error handling propagates correctly
   - State management is consistent

2. Test complete user flows:
   - First-time user flow (permissions)
   - Happy path: ask question, hear response
   - Error recovery flows
   - Session timeout and recovery
   - Multiple questions in succession

3. Fix integration issues:
   - Race conditions
   - State synchronization bugs
   - Memory leaks
   - Event handler cleanup

4. Verify cross-browser compatibility:
   - Chrome/Edge (desktop)
   - iOS Safari
   - Android Chrome
   - Firefox (with fallback)

## Implementation Plan

### 1. Create Integration Checklist

**Session Management Flow**:
- [ ] Page loads ‚Üí health check succeeds
- [ ] Health check success ‚Üí session auto-created
- [ ] Session created ‚Üí heartbeat starts
- [ ] Session timeout ‚Üí auto-reconnect works
- [ ] Backend restart ‚Üí frontend recovers

**Voice Input Flow**:
- [ ] Button press ‚Üí recognition starts
- [ ] Speech detected ‚Üí interim transcript updates
- [ ] Button release ‚Üí recognition stops
- [ ] Final transcript ‚Üí API call made
- [ ] Empty transcript ‚Üí no API call

**Voice Output Flow**:
- [ ] Response received ‚Üí TTS starts automatically
- [ ] TTS starts ‚Üí visual indicator appears
- [ ] User taps stop ‚Üí TTS stops immediately
- [ ] New response ‚Üí old TTS cancelled
- [ ] TTS not supported ‚Üí still shows text

**Error Handling Flow**:
- [ ] Network error ‚Üí auto-retry triggered
- [ ] Permission denied ‚Üí fallback shown
- [ ] Browser unsupported ‚Üí text input shown
- [ ] Backend down ‚Üí reconnect UI shown
- [ ] Session lost ‚Üí new session created

### 2. Fix Common Integration Issues

```typescript
// web/app/page.tsx - Example fixes

// Fix: Prevent duplicate API calls
const isRequestInFlight = useRef(false);

const handleReleaseToTalk = async () => {
  if (isRequestInFlight.current) return;
  
  isRequestInFlight.current = true;
  try {
    // ... API call
  } finally {
    isRequestInFlight.current = false;
  }
};

// Fix: Clean up TTS on unmount
useEffect(() => {
  return () => {
    stopSpeaking();
  };
}, []);

// Fix: Cancel recognition on component unmount
useEffect(() => {
  return () => {
    if (isListening) {
      stopListening();
    }
  };
}, []);

// Fix: Handle rapid button presses
const handlePress = useDebouncedCallback(() => {
  if (!isProcessing) {
    startListening();
  }
}, 300);
```

### 3. Add Debug Mode

```typescript
// web/lib/debug.ts
export const DEBUG = process.env.NODE_ENV === 'development';

export function debugLog(category: string, ...args: any[]) {
  if (DEBUG) {
    console.log(`[${category}]`, ...args);
  }
}

// Usage in components:
debugLog('SpeechRecognition', 'Started listening');
debugLog('API', 'Sending question:', question);
debugLog('TTS', 'Speaking:', text.substring(0, 50));
```

### 4. Add State Debugging Component

```typescript
// web/components/DebugPanel.tsx (development only)
"use client";

import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";

interface DebugPanelProps {
  state: {
    sessionId: string | null;
    status: string;
    isListening: boolean;
    isProcessing: boolean;
    isSpeaking: boolean;
    messageCount: number;
  };
}

export function DebugPanel({ state }: DebugPanelProps) {
  if (process.env.NODE_ENV !== 'development') return null;

  return (
    <Card className="fixed bottom-4 left-4 w-64 opacity-90">
      <CardHeader>
        <CardTitle className="text-xs">Debug State</CardTitle>
      </CardHeader>
      <CardContent className="text-xs space-y-1">
        <div>Session: {state.sessionId?.substring(0, 8) || 'none'}</div>
        <div>Status: {state.status}</div>
        <div>Listening: {state.isListening ? 'üé§' : '‚ùå'}</div>
        <div>Processing: {state.isProcessing ? '‚è≥' : '‚ùå'}</div>
        <div>Speaking: {state.isSpeaking ? 'üîä' : '‚ùå'}</div>
        <div>Messages: {state.messageCount}</div>
      </CardContent>
    </Card>
  );
}
```

## Test Plan

### Manual Integration Testing

1. **Cold Start Flow**:
   - Open app in fresh browser
   - Verify health check
   - Verify session created
   - Verify button enabled
   - Ask first question
   - Verify full flow works

2. **Multi-Question Flow**:
   - Ask 5 questions in succession
   - Verify no memory leaks
   - Verify state remains consistent
   - Verify history builds correctly

3. **Error Recovery**:
   - Simulate network failure
   - Verify auto-retry
   - Restore network
   - Verify recovery

4. **Session Timeout**:
   - Wait 11 minutes
   - Try to ask question
   - Verify new session created
   - Verify question succeeds

5. **Cross-Browser**:
   - Test in Chrome (desktop)
   - Test in iOS Safari
   - Test in Android Chrome
   - Test in Firefox (verify fallback)

### Integration Issues Checklist

- [ ] No race conditions in API calls
- [ ] No memory leaks in long sessions
- [ ] Event listeners properly cleaned up
- [ ] State updates don't cause infinite loops
- [ ] TTS doesn't overlap
- [ ] Recognition doesn't get stuck "on"
- [ ] Heartbeat continues during TTS playback
- [ ] Button states are always correct
- [ ] Error messages clear after recovery

## Verification

```bash
cd /home/sean/workspace/janus/web
pnpm dev

# Open DevTools Console
# Enable verbose logging
localStorage.setItem('debug', 'true')

# Run through all test scenarios above
# Watch console for errors, warnings
# Check Network tab for API calls
# Monitor Memory tab for leaks

# Production build test
pnpm build
cd ../api
go run cmd/server/main.go

# Test production build from http://localhost:3000
```

## Files Modified

### New Files
- `web/lib/debug.ts` - Debug logging utilities
- `web/components/DebugPanel.tsx` - Development debug UI

### Modified Files
- `web/app/page.tsx` - Fix integration issues and add debug support
- `web/hooks/useSpeechRecognition.ts` - Add cleanup and debug logging
- `web/hooks/useSpeechSynthesis.ts` - Add cleanup and debug logging
- `web/lib/api-client.ts` - Add request logging and better error handling


