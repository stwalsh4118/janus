# [4-6] Implement conversation history and improved layout

[Back to task list](./tasks.md)

## Description

Enhance the UI layout to display conversation history with clear visual distinction between user questions and assistant responses. Improve the overall layout for better mobile usability and scrollable history that preserves context across the session.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-12 00:00:00 | Created | N/A | Proposed | Task file created | Sean |

## Requirements

**Current State:** App shows current transcript and response only. No conversation history preserved.

1. Store conversation history in component state
2. Display history in scrollable area:
   - User messages on right (or distinguished style)
   - Assistant responses on left (or distinguished style)
   - Timestamps for each message
   - Auto-scroll to latest message

3. Improve layout:
   - Fixed status bar at top
   - Scrollable conversation history in middle
   - Fixed PushToTalk button at bottom
   - Responsive design (portrait and landscape)

4. Handle long conversations:
   - Virtualized list for performance (if needed)
   - Clear history button
   - Session persistence

## Implementation Plan

### 1. Define Message Types
```typescript
// web/lib/types.ts
export interface Message {
  id: string;
  role: "user" | "assistant";
  content: string;
  timestamp: Date;
  isPlaying?: boolean; // For TTS state
}

export interface ConversationState {
  messages: Message[];
  currentTranscript: string;
  isProcessing: boolean;
}
```

### 2. Create MessageBubble Component
```typescript
// web/components/MessageBubble.tsx
"use client";

import { Card, CardContent } from "@/components/ui/card";
import { Volume2, User, Bot } from "lucide-react";
import { formatDistanceToNow } from "date-fns";
import type { Message } from "@/lib/types";

interface MessageBubbleProps {
  message: Message;
  onPlayAudio?: () => void;
}

export function MessageBubble({ message, onPlayAudio }: MessageBubbleProps) {
  const isUser = message.role === "user";

  return (
    <div className={`flex gap-3 ${isUser ? "flex-row-reverse" : "flex-row"}`}>
      {/* Avatar */}
      <div className={`
        flex-shrink-0 h-10 w-10 rounded-full flex items-center justify-center
        ${isUser ? "bg-primary" : "bg-secondary"}
      `}>
        {isUser ? (
          <User className="h-5 w-5" />
        ) : (
          <Bot className="h-5 w-5" />
        )}
      </div>

      {/* Message Content */}
      <div className={`flex-1 max-w-[80%] ${isUser ? "items-end" : "items-start"}`}>
        <Card className={isUser ? "bg-primary text-primary-foreground" : ""}>
          <CardContent className="pt-4">
            <p className="text-sm whitespace-pre-wrap break-words">
              {message.content}
            </p>
            
            <div className="flex items-center justify-between mt-2 pt-2 border-t border-border/50">
              <span className="text-xs opacity-70">
                {formatDistanceToNow(message.timestamp, { addSuffix: true })}
              </span>
              
              {!isUser && onPlayAudio && (
                <button
                  onClick={onPlayAudio}
                  className="text-xs flex items-center gap-1 hover:opacity-80"
                >
                  <Volume2 className="h-3 w-3" />
                  Play
                </button>
              )}
            </div>
          </CardContent>
        </Card>
      </div>
    </div>
  );
}
```

### 3. Create ConversationHistory Component
```typescript
// web/components/ConversationHistory.tsx
"use client";

import { useEffect, useRef } from "react";
import { ScrollArea } from "@/components/ui/scroll-area";
import { MessageBubble } from "./MessageBubble";
import type { Message } from "@/lib/types";

interface ConversationHistoryProps {
  messages: Message[];
  currentTranscript?: string;
  onPlayMessage?: (message: Message) => void;
}

export function ConversationHistory({ 
  messages, 
  currentTranscript,
  onPlayMessage 
}: ConversationHistoryProps) {
  const scrollRef = useRef<HTMLDivElement>(null);

  // Auto-scroll to bottom when new message added
  useEffect(() => {
    if (scrollRef.current) {
      scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
    }
  }, [messages.length]);

  return (
    <ScrollArea className="flex-1 px-4" ref={scrollRef}>
      <div className="space-y-4 py-4">
        {messages.length === 0 && (
          <div className="text-center text-muted-foreground py-12">
            <p>No messages yet</p>
            <p className="text-sm mt-2">Hold the button to ask a question</p>
          </div>
        )}

        {messages.map((message) => (
          <MessageBubble
            key={message.id}
            message={message}
            onPlayAudio={
              message.role === "assistant" 
                ? () => onPlayMessage?.(message)
                : undefined
            }
          />
        ))}

        {/* Show current transcript being recorded */}
        {currentTranscript && (
          <div className="flex gap-3 flex-row-reverse">
            <div className="flex-shrink-0 h-10 w-10 rounded-full bg-primary flex items-center justify-center">
              <User className="h-5 w-5" />
            </div>
            <Card className="flex-1 max-w-[80%] bg-primary/20 border-primary">
              <CardContent className="pt-4">
                <p className="text-sm opacity-70 animate-pulse">
                  {currentTranscript}
                </p>
              </CardContent>
            </Card>
          </div>
        )}
      </div>
    </ScrollArea>
  );
}
```

### 4. Update page.tsx with Conversation State
```typescript
// web/app/page.tsx
"use client";

import { useState } from "react";
import { v4 as uuidv4 } from "uuid"; // May need to add uuid package
import { ConversationHistory } from "@/components/ConversationHistory";
import type { Message } from "@/lib/types";

export default function Home() {
  const [messages, setMessages] = useState<Message[]>([]);
  
  const handleReleaseToTalk = async () => {
    stopListening();
    
    if (!sessionId || !transcript) return;

    // Add user message
    const userMessage: Message = {
      id: uuidv4(),
      role: "user",
      content: transcript,
      timestamp: new Date(),
    };
    setMessages(prev => [...prev, userMessage]);

    setIsProcessing(true);
    try {
      const answer = await apiClient.ask(sessionId, transcript);
      
      // Add assistant message
      const assistantMessage: Message = {
        id: uuidv4(),
        role: "assistant",
        content: answer,
        timestamp: new Date(),
      };
      setMessages(prev => [...prev, assistantMessage]);
      
      // Auto-play response
      if (ttsSupported && answer) {
        speak(answer);
      }

      resetTranscript();
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to get response');
    } finally {
      setIsProcessing(false);
    }
  };

  const handlePlayMessage = (message: Message) => {
    if (ttsSupported) {
      speak(message.content);
    }
  };

  return (
    <main className="min-h-screen bg-background flex flex-col">
      {/* Fixed Header */}
      <div className="flex-shrink-0 p-4 border-b">
        <StatusIndicator
          status={status}
          version={healthData?.version}
          activeSessions={healthData?.active_sessions}
        />
      </div>

      {/* Scrollable Conversation */}
      <ConversationHistory
        messages={messages}
        currentTranscript={transcript + interimTranscript}
        onPlayMessage={handlePlayMessage}
      />

      {/* Fixed Push-to-Talk Button */}
      <div className="flex-shrink-0 flex justify-center py-4 border-t bg-background">
        <PushToTalk
          disabled={status !== "connected" || !sessionId}
          isListening={isListening}
          isProcessing={isProcessing}
          isSpeaking={isSpeaking}
          error={speechError}
          onPress={handlePressToTalk}
          onRelease={handleReleaseToTalk}
        />
      </div>
    </main>
  );
}
```

## Test Plan

### Success Criteria

- [ ] Conversation history displays all messages
- [ ] User messages visually distinct from assistant messages
- [ ] Timestamps show relative time
- [ ] History auto-scrolls to latest message
- [ ] Can replay any assistant message by tapping
- [ ] Current transcript shows in real-time
- [ ] Layout works in portrait and landscape
- [ ] Scrolling is smooth with many messages
- [ ] Header and button remain fixed during scroll
- [ ] Messages preserve across session

## Verification

```bash
cd /home/sean/workspace/janus/web
pnpm dev

# Manual testing:
# 1. Ask several questions
# 2. Verify history builds up
# 3. Verify auto-scroll to bottom
# 4. Tap play button on old response
# 5. Verify TTS plays that message
# 6. Scroll through history
# 7. Verify button remains fixed
# 8. Test in landscape mode
```

## Files Modified

### New Files
- `web/components/MessageBubble.tsx` - Individual message display
- `web/components/ConversationHistory.tsx` - Conversation history container

### Modified Files
- `web/lib/types.ts` - Add Message and ConversationState types
- `web/app/page.tsx` - Implement conversation state and history
- `web/package.json` - Add uuid package (if needed: `pnpm add uuid @types/uuid`)


