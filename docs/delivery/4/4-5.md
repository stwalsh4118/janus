# [4-5] Implement mobile optimizations and accessibility

[Back to task list](./tasks.md)

## Description

Add mobile-specific optimizations including preventing zoom on button interactions, keeping screen awake during active sessions, handling orientation changes gracefully, and improving touch target sizes throughout the app.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-12 00:00:00 | Created | N/A | Proposed | Task file created | Sean |

## Requirements

1. Prevent zoom on form inputs and button presses
2. Keep screen awake during active sessions (Wake Lock API)
3. Handle screen orientation changes
4. Ensure all interactive elements meet minimum 44x44px touch target
5. Add high contrast mode for outdoor visibility
6. Handle phone calls gracefully (pause on visibility change)

## Implementation Plan

### 1. Create useWakeLock Hook
```typescript
// web/hooks/useWakeLock.ts
import { useEffect, useRef, useState } from 'react';

export function useWakeLock(enabled: boolean) {
  const [isSupported, setIsSupported] = useState(false);
  const wakeLockRef = useRef<WakeLockSentinel | null>(null);

  useEffect(() => {
    setIsSupported('wakeLock' in navigator);
  }, []);

  useEffect(() => {
    if (!isSupported || !enabled) return;

    const requestWakeLock = async () => {
      try {
        wakeLockRef.current = await navigator.wakeLock.request('screen');
        console.log('Wake lock active');

        wakeLockRef.current.addEventListener('release', () => {
          console.log('Wake lock released');
        });
      } catch (err) {
        console.error('Failed to acquire wake lock:', err);
      }
    };

    const handleVisibilityChange = () => {
      if (document.visibilityState === 'visible' && enabled) {
        requestWakeLock();
      }
    };

    requestWakeLock();
    document.addEventListener('visibilitychange', handleVisibilityChange);

    return () => {
      document.removeEventListener('visibilitychange', handleVisibilityChange);
      if (wakeLockRef.current) {
        wakeLockRef.current.release();
      }
    };
  }, [isSupported, enabled]);

  return { isSupported, isActive: wakeLockRef.current !== null };
}
```

### 2. Update globals.css for Mobile
```css
/* web/app/globals.css */
@layer base {
  * {
    /* Disable tap highlight on mobile */
    -webkit-tap-highlight-color: transparent;
    
    /* Disable text selection for UI elements */
    -webkit-touch-callout: none;
  }

  /* Prevent zoom on inputs */
  input[type="text"],
  input[type="email"],
  input[type="tel"],
  textarea {
    font-size: 16px !important; /* Prevents iOS zoom */
  }

  /* High contrast for outdoor use */
  @media (prefers-contrast: more) {
    :root {
      --foreground: 0 0% 0%;
      --background: 0 0% 100%;
    }
  }

  /* Ensure minimum touch targets */
  button,
  a,
  input[type="button"],
  input[type="submit"] {
    min-height: 44px;
    min-width: 44px;
  }
}
```

### 3. Handle Visibility Changes for TTS
```typescript
// web/app/page.tsx
useEffect(() => {
  const handleVisibilityChange = () => {
    if (document.hidden) {
      // Page is hidden (phone call, switched app, etc.)
      if (isSpeaking) {
        pauseSpeech();
      }
    } else {
      // Page is visible again
      if (wasSpeaking) {
        resumeSpeech();
      }
    }
  };

  document.addEventListener('visibilitychange', handleVisibilityChange);
  return () => {
    document.removeEventListener('visibilitychange', handleVisibilityChange);
  };
}, [isSpeaking, pauseSpeech, resumeSpeech]);
```

### 4. Add Wake Lock to Active Sessions
```typescript
// web/app/page.tsx
import { useWakeLock } from "@/hooks/useWakeLock";

export default function Home() {
  const { isSupported: wakeLockSupported } = useWakeLock(!!sessionId);
  
  // ... rest of component
}
```

### 5. Update layout.tsx Meta Tags
```typescript
// web/app/layout.tsx
<head>
  {/* Existing meta tags... */}
  
  {/* Prevent zoom */}
  <meta 
    name="viewport" 
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" 
  />
  
  {/* High contrast support */}
  <meta name="color-scheme" content="light dark" />
  
  {/* Prevent phone number detection */}
  <meta name="format-detection" content="telephone=no" />
</head>
```

## Test Plan

### Success Criteria

- [ ] Screen stays awake during active session
- [ ] Wake lock releases when session ends
- [ ] Double-tap doesn't zoom on button
- [ ] Inputs don't trigger iOS zoom
- [ ] Orientation changes don't break layout
- [ ] TTS pauses when app goes to background
- [ ] TTS resumes when app returns to foreground
- [ ] All buttons meet 44x44px minimum
- [ ] High contrast mode works in bright sunlight
- [ ] Phone calls don't interrupt session (app pauses gracefully)

### Manual Testing

1. **Wake Lock**:
   - Start session on mobile
   - Leave app open
   - Verify screen doesn't sleep
   - End session
   - Verify screen can sleep again

2. **Orientation**:
   - Rotate device
   - Verify layout adapts
   - Test button remains usable

3. **Visibility**:
   - Start TTS playback
   - Switch to another app
   - Verify TTS pauses
   - Return to app
   - Verify TTS resumes

4. **Touch Targets**:
   - Use browser DevTools touch emulation
   - Verify all buttons are at least 44x44px

## Verification

```bash
cd /home/sean/workspace/janus/web
pnpm dev

# Test on mobile device via Tailscale:
# 1. Open app on phone
# 2. Start a session
# 3. Verify screen stays awake
# 4. Rotate device
# 5. Verify layout remains usable
# 6. Start TTS playback
# 7. Press home button
# 8. Return to app
# 9. Verify TTS resumes
```

## Files Modified

### New Files
- `web/hooks/useWakeLock.ts` - Wake lock implementation

### Modified Files
- `web/app/globals.css` - Mobile optimizations and touch target sizes
- `web/app/layout.tsx` - Additional mobile meta tags
- `web/app/page.tsx` - Integrate wake lock and visibility handling


