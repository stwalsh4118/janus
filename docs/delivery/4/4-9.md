# [4-9] Performance optimization and polish

[Back to task list](./tasks.md)

## Description

Optimize the application for production including bundle size reduction, lazy loading, animation improvements, loading states, and final UX polish for a smooth driving-safe experience.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-12 00:00:00 | Created | N/A | Proposed | Task file created | Sean |

## Requirements

1. Optimize bundle size:
   - Analyze and reduce unnecessary dependencies
   - Lazy load non-critical components
   - Tree-shake unused code
   - Optimize images and assets

2. Improve loading states:
   - Add skeleton loaders
   - Progressive enhancement
   - Optimistic UI updates
   - Smooth transitions

3. Animation polish:
   - Smooth button press animations
   - Fade transitions for messages
   - Loading spinners
   - Pulse effects during recording

4. Performance optimizations:
   - Memoize expensive computations
   - Debounce rapid interactions
   - Optimize re-renders
   - Reduce API call frequency

## Implementation Plan

### 1. Analyze Bundle Size

```bash
# Add bundle analyzer
cd web
pnpm add -D @next/bundle-analyzer

# Update next.config.ts
const withBundleAnalyzer = require('@next/bundle-analyzer')({
  enabled: process.env.ANALYZE === 'true',
});

module.exports = withBundleAnalyzer(nextConfig);

# Analyze
ANALYZE=true pnpm build
```

### 2. Add Skeleton Loaders

```typescript
// web/components/SkeletonMessage.tsx
import { Card, CardContent } from "@/components/ui/card";
import { Skeleton } from "@/components/ui/skeleton";

export function SkeletonMessage() {
  return (
    <div className="flex gap-3">
      <Skeleton className="h-10 w-10 rounded-full" />
      <Card className="flex-1 max-w-[80%]">
        <CardContent className="pt-4 space-y-2">
          <Skeleton className="h-4 w-full" />
          <Skeleton className="h-4 w-3/4" />
          <Skeleton className="h-4 w-1/2" />
        </CardContent>
      </Card>
    </div>
  );
}
```

### 3. Optimize Components with React.memo

```typescript
// web/components/MessageBubble.tsx
import { memo } from 'react';

export const MessageBubble = memo(function MessageBubble({ 
  message, 
  onPlayAudio 
}: MessageBubbleProps) {
  // ... component code
}, (prevProps, nextProps) => {
  // Custom comparison for better performance
  return (
    prevProps.message.id === nextProps.message.id &&
    prevProps.message.isPlaying === nextProps.message.isPlaying
  );
});
```

### 4. Add Optimistic UI Updates

```typescript
// web/app/page.tsx
const [optimisticMessage, setOptimisticMessage] = useState<Message | null>(null);

const handleReleaseToTalk = async () => {
  stopListening();
  
  if (!sessionId || !transcript) return;

  // Add user message immediately
  const userMessage: Message = {
    id: uuidv4(),
    role: "user",
    content: transcript,
    timestamp: new Date(),
  };
  setMessages(prev => [...prev, userMessage]);

  // Show optimistic "thinking" message
  const thinkingMessage: Message = {
    id: 'thinking',
    role: "assistant",
    content: "...",
    timestamp: new Date(),
  };
  setOptimisticMessage(thinkingMessage);
  setIsProcessing(true);

  try {
    const answer = await apiClient.ask(sessionId, transcript);
    
    // Replace optimistic message with real response
    setOptimisticMessage(null);
    const assistantMessage: Message = {
      id: uuidv4(),
      role: "assistant",
      content: answer,
      timestamp: new Date(),
    };
    setMessages(prev => [...prev, assistantMessage]);
    
    if (ttsSupported && answer) {
      speak(answer);
    }
  } catch (err) {
    setOptimisticMessage(null);
    // ... error handling
  } finally {
    setIsProcessing(false);
  }
};

// In render:
const allMessages = optimisticMessage 
  ? [...messages, optimisticMessage]
  : messages;
```

### 5. Add Smooth Animations

```css
/* web/app/globals.css */
@layer utilities {
  /* Message fade-in animation */
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fadeIn {
    animation: fadeIn 0.3s ease-out;
  }

  /* Thinking dots animation */
  @keyframes thinking {
    0%, 20% { content: '.'; }
    40% { content: '..'; }
    60%, 100% { content: '...'; }
  }

  .thinking::after {
    content: '';
    animation: thinking 1.5s infinite;
  }

  /* Button press feedback */
  .active-press {
    transform: scale(0.95);
    transition: transform 0.1s ease-out;
  }

  /* Smooth scroll */
  .smooth-scroll {
    scroll-behavior: smooth;
  }
}
```

### 6. Debounce Rapid Interactions

```typescript
// web/lib/utils.ts
export function debounce<T extends (...args: any[]) => any>(
  func: T,
  wait: number
): (...args: Parameters<T>) => void {
  let timeout: NodeJS.Timeout;
  return function executedFunction(...args: Parameters<T>) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// Usage in components:
const debouncedStartListening = useMemo(
  () => debounce(startListening, 300),
  [startListening]
);
```

### 7. Optimize Re-renders

```typescript
// web/app/page.tsx
import { useCallback, useMemo } from 'react';

// Memoize callbacks
const handlePressToTalk = useCallback(() => {
  resetTranscript();
  startListening();
}, [resetTranscript, startListening]);

const handlePlayMessage = useCallback((message: Message) => {
  if (ttsSupported) {
    speak(message.content);
  }
}, [ttsSupported, speak]);

// Memoize expensive computations
const displayTranscript = useMemo(
  () => transcript + interimTranscript,
  [transcript, interimTranscript]
);
```

### 8. Add Loading States

```typescript
// web/components/LoadingState.tsx
import { Loader2 } from "lucide-react";

interface LoadingStateProps {
  message?: string;
}

export function LoadingState({ message = "Loading..." }: LoadingStateProps) {
  return (
    <div className="flex flex-col items-center justify-center py-12 gap-4">
      <Loader2 className="h-8 w-8 animate-spin text-primary" />
      <p className="text-sm text-muted-foreground">{message}</p>
    </div>
  );
}

// Usage in page.tsx
{status === "connecting" && (
  <LoadingState message="Connecting to backend..." />
)}

{isProcessing && (
  <LoadingState message="Processing your question..." />
)}
```

## Test Plan

### Performance Metrics

- [ ] Bundle size < 500KB (gzipped)
- [ ] First Contentful Paint < 1.5s
- [ ] Time to Interactive < 2.5s
- [ ] No jank in animations (60fps)
- [ ] Memory usage stable over 10+ questions
- [ ] API calls properly debounced
- [ ] No unnecessary re-renders (React DevTools)

### UX Polish Checklist

- [ ] All transitions are smooth (no jank)
- [ ] Loading states provide feedback
- [ ] Button press feels responsive
- [ ] Animations don't distract while driving
- [ ] Error states are clear and actionable
- [ ] Success states provide positive feedback
- [ ] No UI flicker or flash
- [ ] Optimistic updates feel instant

## Verification

```bash
cd /home/sean/workspace/janus/web

# Check bundle size
pnpm build
ls -lh out/_next/static/chunks/*.js

# Run Lighthouse audit
# Open production build in Chrome
# DevTools > Lighthouse > Run audit
# Target: Performance > 90, Accessibility > 95

# Test on actual mobile device
# Use Chrome DevTools Performance recording
# Record full interaction
# Analyze for jank and slow operations
```

## Files Modified

### New Files
- `web/components/SkeletonMessage.tsx` - Loading skeleton for messages
- `web/components/LoadingState.tsx` - Generic loading component
- `web/lib/utils.ts` - Add debounce utility (if not exists)

### Modified Files
- `web/next.config.ts` - Add bundle analyzer
- `web/app/globals.css` - Add smooth animations
- `web/app/page.tsx` - Add optimistic updates and memoization
- `web/components/MessageBubble.tsx` - Add React.memo
- `web/components/ConversationHistory.tsx` - Optimize rendering
- `web/components/PushToTalk.tsx` - Improve animation smoothness
- `web/package.json` - Add @next/bundle-analyzer


