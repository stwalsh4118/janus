# [4-4] Enhance PushToTalk component with improved UX

[Back to task list](./tasks.md)

## Description

Enhance the existing PushToTalk component with visual state feedback, larger touch targets for driving safety, and better mobile interaction handling. Improve the button size to 200x200px as specified in the PRD and add pulsing animations during recording.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-12 00:00:00 | Created | N/A | Proposed | Task file created | Sean |

## Requirements

**Current State:** PushToTalk component exists but is only 48x48 (192px). Needs to be larger (200x200px minimum) for safe eyes-free interaction while driving.

1. Increase button size to 200x200px minimum
2. Add clear visual states:
   - Idle: Ready to record
   - Recording: Pulsing animation
   - Processing: Spinner
   - Speaking: Different color/icon
   - Error: Red with error icon

3. Improve touch handling:
   - Prevent accidental double-taps
   - Handle touch outside button during hold
   - Add haptic feedback if available
   - Prevent page scrolling during interaction

4. Add visual feedback:
   - Pulsing border during recording
   - Waveform animation (optional)
   - Clear state text below button

## Implementation Plan

### 1. Update PushToTalk Component
```typescript
// web/components/PushToTalk.tsx
"use client";

import { useState, useEffect } from "react";
import { Button } from "@/components/ui/button";
import { Mic, MicOff, Loader2 } from "lucide-react";

type ButtonState = "idle" | "recording" | "processing" | "speaking" | "error";

interface PushToTalkProps {
  disabled?: boolean;
  isListening?: boolean;
  isProcessing?: boolean;
  isSpeaking?: boolean;
  error?: string | null;
  onPress?: () => void;
  onRelease?: () => void;
}

export function PushToTalk({ 
  disabled, 
  isListening,
  isProcessing,
  isSpeaking,
  error,
  onPress, 
  onRelease 
}: PushToTalkProps) {
  const [isPressed, setIsPressed] = useState(false);

  // Determine visual state
  const getState = (): ButtonState => {
    if (error) return "error";
    if (isSpeaking) return "speaking";
    if (isProcessing) return "processing";
    if (isListening) return "recording";
    return "idle";
  };

  const state = getState();

  const handleMouseDown = () => {
    if (disabled || isProcessing || isSpeaking) return;
    setIsPressed(true);
    onPress?.();
    
    // Haptic feedback
    if (window.navigator.vibrate) {
      window.navigator.vibrate(50);
    }
  };

  const handleMouseUp = () => {
    if (disabled) return;
    setIsPressed(false);
    onRelease?.();
  };

  const handleTouchStart = (e: React.TouchEvent) => {
    e.preventDefault();
    if (disabled || isProcessing || isSpeaking) return;
    setIsPressed(true);
    onPress?.();
    
    // Haptic feedback
    if (window.navigator.vibrate) {
      window.navigator.vibrate(50);
    }
  };

  const handleTouchEnd = (e: React.TouchEvent) => {
    e.preventDefault();
    if (disabled) return;
    setIsPressed(false);
    onRelease?.();
  };

  const stateConfig = {
    idle: {
      label: "Hold to Talk",
      icon: MicOff,
      className: "bg-primary hover:bg-primary/90",
      pulseClassName: "",
    },
    recording: {
      label: "Recording...",
      icon: Mic,
      className: "bg-red-500 hover:bg-red-600",
      pulseClassName: "animate-pulse ring-4 ring-red-500/50",
    },
    processing: {
      label: "Processing...",
      icon: Loader2,
      className: "bg-blue-500",
      pulseClassName: "animate-pulse",
    },
    speaking: {
      label: "Speaking...",
      icon: Mic,
      className: "bg-green-500",
      pulseClassName: "animate-pulse",
    },
    error: {
      label: "Error",
      icon: MicOff,
      className: "bg-destructive",
      pulseClassName: "",
    },
  };

  const config = stateConfig[state];
  const Icon = config.icon;

  return (
    <div className="flex flex-col items-center gap-6 py-8 touch-none select-none">
      <Button
        size="lg"
        disabled={disabled || isProcessing || isSpeaking}
        onMouseDown={handleMouseDown}
        onMouseUp={handleMouseUp}
        onMouseLeave={handleMouseUp}
        onTouchStart={handleTouchStart}
        onTouchEnd={handleTouchEnd}
        className={`
          h-[200px] w-[200px] rounded-full transition-all duration-200
          ${isPressed ? "scale-95 shadow-inner" : "scale-100 shadow-2xl"}
          ${config.className}
          ${config.pulseClassName}
          ${disabled ? "opacity-50 cursor-not-allowed" : "cursor-pointer active:scale-95"}
        `}
        style={{
          WebkitTouchCallout: "none",
          WebkitUserSelect: "none",
          touchAction: "none",
        }}
      >
        <div className="flex flex-col items-center gap-3">
          <Icon className="h-20 w-20" />
          <span className="text-lg font-bold">
            {config.label}
          </span>
        </div>
      </Button>
      
      <div className="text-center max-w-sm px-4">
        {error && (
          <p className="text-sm text-destructive font-medium">
            {error}
          </p>
        )}
        {!error && (
          <p className="text-sm text-muted-foreground">
            {disabled
              ? "Connect to backend to start"
              : state === "idle"
              ? "Press and hold to ask a question"
              : state === "recording"
              ? "Speak your question clearly"
              : state === "processing"
              ? "Waiting for response..."
              : "Listening to response"}
          </p>
        )}
      </div>
    </div>
  );
}
```

### 2. Update page.tsx to Pass State Props
```typescript
// web/app/page.tsx
const [isProcessing, setIsProcessing] = useState(false);

const handleReleaseToTalk = async () => {
  stopListening();
  
  if (!sessionId || !transcript) return;

  setIsProcessing(true);
  try {
    const answer = await apiClient.ask(sessionId, transcript);
    setResponse(answer);
    
    if (ttsSupported && answer) {
      speak(answer);
    }
  } catch (err) {
    setError(err instanceof Error ? err.message : 'Failed to get response');
  } finally {
    setIsProcessing(false);
  }
};

return (
  <PushToTalk
    disabled={status !== "connected" || !sessionId}
    isListening={isListening}
    isProcessing={isProcessing}
    isSpeaking={isSpeaking}
    error={speechError}
    onPress={handlePressToTalk}
    onRelease={handleReleaseToTalk}
  />
);
```

## Test Plan

### Success Criteria

- [ ] Button is exactly 200x200px
- [ ] Button has clear visual states for each mode
- [ ] Pulsing animation appears during recording
- [ ] Touch targets work reliably on mobile
- [ ] Haptic feedback triggers on supported devices
- [ ] Button doesn't accidentally scroll page
- [ ] State text is readable and accurate
- [ ] Disabled state is visually clear
- [ ] Error state is prominently displayed in red
- [ ] Button can be pressed without looking at screen

### Manual Testing

1. **Desktop**:
   - Test mouse down/up interaction
   - Verify hover states
   - Test mouse leave during hold

2. **Mobile**:
   - Test touch and hold
   - Verify haptic feedback (if available)
   - Test with gloves (if applicable)
   - Verify large enough for eyes-free use

3. **States**:
   - Test all 5 visual states
   - Verify animations are smooth
   - Verify state transitions are clear

## Verification

```bash
cd /home/sean/workspace/janus/web
pnpm dev

# Manual testing:
# 1. Open DevTools and inspect button
# 2. Verify dimensions are 200x200px
# 3. Test press and hold
# 4. Verify pulsing animation during recording
# 5. Test on mobile device via Tailscale
# 6. Try using button without looking at screen
```

## Files Modified

### Modified Files
- `web/components/PushToTalk.tsx` - Enhanced with larger size and better states
- `web/app/page.tsx` - Pass additional state props to PushToTalk
- `web/lib/types.ts` - Update PushToTalkProps interface


