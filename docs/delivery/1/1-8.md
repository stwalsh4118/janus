# [1-8] Enhance GET /api/health endpoint with session metrics

[Back to task list](./tasks.md)

## Description

Enhance the existing health check endpoint to include session-related metrics such as active session count and basic memory usage information. This provides visibility into server state and resource utilization.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-11 00:00:00 | Created | N/A | Proposed | Task file created | Sean |

## Requirements

1. Modify existing `GET /api/health` endpoint
2. Add active session count
3. Add memory usage statistics (optional)
4. Maintain existing health check fields (status, version, uptime)
5. Return consistent JSON format
6. Ensure endpoint remains lightweight and fast

## Implementation Plan

### 1. Update health handler
Modify `internal/api/handlers/health.go`:

```go
package handlers

import (
    "net/http"
    "runtime"
    "time"

    "github.com/gin-gonic/gin"
    "github.com/sean/janus/internal/session"
)

type HealthHandler struct {
    startTime time.Time
    version   string
    manager   session.Manager
}

func NewHealthHandler(version string, manager session.Manager) *HealthHandler {
    return &HealthHandler{
        startTime: time.Now(),
        version:   version,
        manager:   manager,
    }
}

type HealthResponse struct {
    Status         string  `json:"status"`
    Version        string  `json:"version"`
    Uptime         string  `json:"uptime"`
    ActiveSessions int     `json:"active_sessions"`
    MemoryUsageMB  float64 `json:"memory_usage_mb,omitempty"`
}

func (h *HealthHandler) Health(c *gin.Context) {
    uptime := time.Since(h.startTime)

    // Get active session count
    sessions := h.manager.GetAllSessions()
    activeCount := len(sessions)

    // Get memory stats (optional)
    var m runtime.MemStats
    runtime.ReadMemStats(&m)
    memoryMB := float64(m.Alloc) / 1024 / 1024

    c.JSON(http.StatusOK, HealthResponse{
        Status:         "healthy",
        Version:        h.version,
        Uptime:         uptime.String(),
        ActiveSessions: activeCount,
        MemoryUsageMB:  memoryMB,
    })
}
```

### 2. Update router to inject dependencies
Modify `internal/api/router.go`:

```go
func SetupRouter(manager session.Manager, workDir string, version string) *gin.Engine {
    router := gin.Default()

    // Middleware
    router.Use(cors.CORSMiddleware())

    // Handlers
    healthHandler := handlers.NewHealthHandler(version, manager)
    sessionHandler := handlers.NewSessionHandler(manager, workDir)

    // Routes
    api := router.Group("/api")
    {
        api.GET("/health", healthHandler.Health)
        api.POST("/session/start", sessionHandler.StartSession)
        api.POST("/ask", sessionHandler.AskQuestion)
        api.POST("/session/end", sessionHandler.EndSession)
        api.POST("/heartbeat", sessionHandler.Heartbeat)
    }

    return router
}
```

### 3. Update main.go to pass version
Modify `cmd/server/main.go`:

```go
const version = "0.1.0"

func main() {
    // ... existing setup ...

    // Setup router with version
    router := api.SetupRouter(sessionManager, workDir, version)

    // ... rest of setup ...
}
```

## Test Plan

### Unit Tests
Modify `internal/api/handlers/health_test.go`:

1. **Test Health Response Structure**:
   - Verify all fields present
   - Verify correct data types

2. **Test Active Session Count**:
   - Mock manager with 0 sessions
   - Verify count is 0
   - Mock manager with 3 sessions
   - Verify count is 3

3. **Test Uptime Calculation**:
   - Create handler
   - Wait 1 second
   - Call health endpoint
   - Verify uptime > 1 second

### Integration Tests
Manual verification:

1. Start server with no sessions
2. Call health endpoint
3. Verify active_sessions: 0
4. Create 3 sessions
5. Call health endpoint
6. Verify active_sessions: 3
7. End 1 session
8. Call health endpoint
9. Verify active_sessions: 2
10. Verify uptime increases over time
11. Verify memory_usage_mb present and reasonable

### Success Criteria
- [ ] Endpoint returns session count
- [ ] Session count accurate
- [ ] Memory usage included (optional)
- [ ] Uptime calculation correct
- [ ] Existing health check fields maintained
- [ ] Response time remains fast (<10ms)
- [ ] Consistent JSON format
- [ ] No impact on server performance

## Verification

```bash
# Check health with no sessions
curl http://localhost:3000/api/health

# Expected response:
# {
#   "status": "healthy",
#   "version": "0.1.0",
#   "uptime": "5m30s",
#   "active_sessions": 0,
#   "memory_usage_mb": 12.5
# }

# Create sessions
SESSION1=$(curl -X POST http://localhost:3000/api/session/start | jq -r '.session_id')
SESSION2=$(curl -X POST http://localhost:3000/api/session/start | jq -r '.session_id')
SESSION3=$(curl -X POST http://localhost:3000/api/session/start | jq -r '.session_id')

# Check health again
curl http://localhost:3000/api/health
# Expected: "active_sessions": 3

# End one session
curl -X POST "http://localhost:3000/api/session/end?session_id=$SESSION1"

# Check health
curl http://localhost:3000/api/health
# Expected: "active_sessions": 2

# Verify response time
time curl http://localhost:3000/api/health
# Should be < 10ms
```

## Files Modified

### Modified Files
- `internal/api/handlers/health.go`
- `internal/api/router.go`
- `cmd/server/main.go`
- `internal/api/handlers/health_test.go`



