# [1-6] Implement POST /api/heartbeat endpoint

[Back to task list](./tasks.md)

## Description

Implement the heartbeat endpoint that allows the frontend to signal that a session is still active, preventing automatic cleanup due to inactivity timeout.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-11 00:00:00 | Created | N/A | Proposed | Task file created | Sean |
| 2025-10-11 13:00:00 | Status Change | Proposed | InProgress | Starting implementation - updating stub to return timestamp | AI Agent |
| 2025-10-11 13:15:00 | Status Change | InProgress | Review | Implementation complete - HeartbeatResponse added, handler updated, all 4 tests passing | AI Agent |
| 2025-10-11 13:30:00 | Status Change | Review | Done | All tests passed, implementation verified | Sean |

## Requirements

1. Replace stub `POST /api/heartbeat?session_id={id}` endpoint
2. Validate session_id parameter
3. Verify session exists
4. Update LastActivity timestamp via SessionManager
5. Return success response with updated timestamp
6. Handle errors:
   - Invalid session_id
   - Session not found

## Implementation Plan

### 1. Define response type
In `internal/api/handlers/session.go`:

```go
type HeartbeatResponse struct {
    Message      string    `json:"message"`
    SessionID    string    `json:"session_id"`
    LastActivity time.Time `json:"last_activity"`
}
```

### 2. Implement Heartbeat handler
```go
func (h *SessionHandler) Heartbeat(c *gin.Context) {
    sessionID := c.Query("session_id")
    if sessionID == "" {
        c.JSON(http.StatusBadRequest, gin.H{
            "error": "session_id query parameter is required",
        })
        return
    }

    // Verify session exists
    sess, err := h.manager.GetSession(sessionID)
    if err != nil {
        c.JSON(http.StatusNotFound, gin.H{
            "error": "Session not found",
            "details": err.Error(),
        })
        return
    }

    // Update activity timestamp
    if err := h.manager.UpdateActivity(sessionID); err != nil {
        c.JSON(http.StatusInternalServerError, gin.H{
            "error": "Failed to update session activity",
            "details": err.Error(),
        })
        return
    }

    // Get updated session to return new timestamp
    sess, _ = h.manager.GetSession(sessionID)

    c.JSON(http.StatusOK, HeartbeatResponse{
        Message:      "Heartbeat received",
        SessionID:    sessionID,
        LastActivity: sess.LastActivity,
    })
}
```

### 3. Router configuration
**Note**: Router already configured in `internal/api/router.go` with `api.POST("/heartbeat", sessionHandler.Heartbeat)` âœ“

## Test Plan

### Unit Tests
In `internal/api/handlers/session_test.go`:

1. **Test Heartbeat Success**:
   - Create session
   - Call heartbeat
   - Verify UpdateActivity called
   - Verify 200 response with timestamp

2. **Test Missing session_id**:
   - Verify 400 response

3. **Test Session Not Found**:
   - Mock manager to return error
   - Verify 404 response

4. **Test LastActivity Update**:
   - Create session
   - Wait 1 second
   - Call heartbeat
   - Verify LastActivity timestamp changed

### Integration Tests
Manual verification:

1. Create session
2. Note initial LastActivity
3. Wait 2 seconds
4. Send heartbeat
5. Verify LastActivity updated
6. Verify session not cleaned up
7. Test heartbeat for non-existent session
8. Verify error response
9. Create session, wait 11 minutes without heartbeat
10. Verify session gets cleaned up
11. Create session, send heartbeat every 30s for 15 minutes
12. Verify session stays active

### Success Criteria
- [ ] Endpoint updates LastActivity timestamp
- [ ] Session validation working
- [ ] Returns updated timestamp in response
- [ ] Prevents session cleanup when called regularly
- [ ] Error handling for invalid/missing sessions
- [ ] Lightweight operation (minimal overhead)
- [ ] Consistent JSON response format

## Verification

```bash
# Create session
SESSION_ID=$(curl -X POST http://localhost:3000/api/session/start | jq -r '.session_id')

# Send initial heartbeat
curl -X POST "http://localhost:3000/api/heartbeat?session_id=$SESSION_ID"

# Expected response:
# {"message":"Heartbeat received","session_id":"<uuid>","last_activity":"2025-10-11T..."}

# Wait 2 seconds and send another
sleep 2
RESPONSE=$(curl -X POST "http://localhost:3000/api/heartbeat?session_id=$SESSION_ID")
echo $RESPONSE

# Verify last_activity timestamp is recent

# Test invalid session
curl -X POST "http://localhost:3000/api/heartbeat?session_id=invalid"
# Expected: 404 error

# Test continuous heartbeat (keeps session alive)
for i in {1..10}; do
  curl -X POST "http://localhost:3000/api/heartbeat?session_id=$SESSION_ID"
  sleep 30
done
```

## Files Modified

### Modified Files
- `internal/api/handlers/session.go` - Add HeartbeatResponse type and update Heartbeat() handler
- `internal/api/handlers/session_test.go` - Update tests to verify HeartbeatResponse and add timestamp validation test



