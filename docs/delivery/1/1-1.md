# [1-1] Define Session data structures and interfaces

[Back to task list](./tasks.md)

## Description

Define the core data structures for Session and Message types, and the SessionManager interface. This task establishes the type system and contracts for session management without implementing the actual logic.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-11 00:00:00 | Created | N/A | Proposed | Task file created | Sean |
| 2025-10-11 12:00:00 | Status Update | Proposed | Agreed | Task approved by user | Sean |
| 2025-10-11 12:01:00 | Status Update | Agreed | InProgress | Started implementation - refactoring stub into proper architecture | Sean |
| 2025-10-11 12:15:00 | Status Update | InProgress | Review | Implementation complete - all types, interface, and constants defined | Sean |

## Requirements

1. Define `Session` struct with all required fields:
   - ID (string)
   - Process (*exec.Cmd)
   - Stdin (io.WriteCloser)
   - Stdout (io.ReadCloser)
   - CreatedAt (time.Time)
   - LastActivity (time.Time)
   - ConversationLog ([]Message)
   
2. Define `Message` struct with:
   - Role (string - "user" or "assistant")
   - Content (string)
   - Timestamp (time.Time)

3. Define `SessionManager` interface with methods:
   - CreateSession() (*Session, error)
   - GetSession(id string) (*Session, error)
   - UpdateActivity(id string) error
   - EndSession(id string) error
   - GetAllSessions() []*Session
   - CleanupInactiveSessions(timeout time.Duration)

4. Add constants for:
   - Default session timeout duration
   - Cursor response timeout
   - Heartbeat interval

## Implementation Plan

### 1. Create types package
Create `internal/session/types.go`:
```go
package session

import (
    "io"
    "os/exec"
    "time"
)

// Message represents a single message in a conversation
type Message struct {
    Role      string    `json:"role"`      // "user" or "assistant"
    Content   string    `json:"content"`
    Timestamp time.Time `json:"timestamp"`
}

// Session represents an active cursor-agent chat session
type Session struct {
    ID              string
    Process         *exec.Cmd
    Stdin           io.WriteCloser
    Stdout          io.ReadCloser
    CreatedAt       time.Time
    LastActivity    time.Time
    ConversationLog []Message
}
```

### 2. Create interface definition
Create `internal/session/manager.go` with interface:
```go
package session

import "time"

// Manager handles session lifecycle operations
type Manager interface {
    CreateSession() (*Session, error)
    GetSession(id string) (*Session, error)
    UpdateActivity(id string) error
    EndSession(id string) error
    GetAllSessions() []*Session
    CleanupInactiveSessions(timeout time.Duration)
}
```

### 3. Define constants
Create `internal/session/constants.go`:
```go
package session

import "time"

const (
    // DefaultSessionTimeout is the duration after which inactive sessions are cleaned up
    DefaultSessionTimeout = 10 * time.Minute
    
    // CursorResponseTimeout is the maximum time to wait for cursor-agent response
    CursorResponseTimeout = 60 * time.Second
    
    // HeartbeatInterval is the expected interval between heartbeat calls
    HeartbeatInterval = 30 * time.Second
)
```

## Test Plan

### Unit Tests
Not required for this task - only type definitions and interfaces.

### Integration Tests
- Verify Go compilation succeeds
- Types can be imported and used by other packages
- Constants are accessible

### Success Criteria
- [ ] Session struct defined with all required fields
- [ ] Message struct defined with correct fields
- [ ] SessionManager interface defined with all methods
- [ ] Constants defined for timeouts and intervals
- [ ] Code compiles without errors
- [ ] Types follow Go naming conventions
- [ ] Proper package structure maintained

## Verification

```bash
# Verify compilation
cd /home/sean/workspace/janus
go build ./internal/session/...

# Verify package structure
go list ./internal/session
```

## Files Modified

### New Files
- `internal/session/types.go` - Session and Message type definitions with process fields and JSON tags
- `internal/session/interface.go` - Manager interface definition
- `internal/session/constants.go` - Timeout and interval constants
- `internal/session/stub_manager.go` - Temporary stub implementation (to be replaced in task 1-2)

### Modified Files
- `internal/api/handlers/session.go` - Updated to use Manager interface instead of concrete type
- `internal/api/handlers/health.go` - Updated to use Manager interface and GetAllSessions()
- `internal/api/router.go` - Updated function signature to accept Manager interface
- `cmd/server/main.go` - Updated to use NewStubManager()

### Deleted Files
- `internal/session/manager.go` - Replaced by the new modular structure

## Verification Results

âœ… All success criteria met:
- Session struct defined with all required fields (including Process, Stdin, Stdout)
- Message struct defined with JSON tags
- SessionManager interface defined with all 6 methods
- Constants defined for DefaultSessionTimeout, CursorResponseTimeout, HeartbeatInterval
- Code compiles without errors: `go build ./...` successful
- Server starts and runs correctly
- Health endpoint returns active session count: tested with 3 sessions
- Session creation works: UUID generation verified
- All stub endpoints functional with new interface


