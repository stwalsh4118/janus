# [1-5] Implement POST /api/session/end endpoint

[Back to task list](./tasks.md)

## Description

Implement the session termination endpoint that gracefully shuts down the cursor-agent process, closes pipes, requests a conversation summary, and removes the session from the manager.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-11 00:00:00 | Created | N/A | Proposed | Task file created | Sean |

## Requirements

1. Replace stub `POST /api/session/end?session_id={id}` endpoint
2. Validate session_id parameter
3. Retrieve session from SessionManager
4. Request conversation summary from cursor-agent (optional enhancement)
5. Close stdin and stdout pipes
6. Terminate cursor-agent process gracefully
7. Remove session from SessionManager
8. Return success response
9. Handle errors:
   - Invalid session_id
   - Session not found
   - Process termination failures

## Implementation Plan

### 1. Define response type
In `internal/api/handlers/session.go`:

```go
type EndSessionResponse struct {
    Message   string `json:"message"`
    SessionID string `json:"session_id"`
    Summary   string `json:"summary,omitempty"`
}
```

### 2. Implement EndSession handler
```go
func (h *SessionHandler) EndSession(c *gin.Context) {
    sessionID := c.Query("session_id")
    if sessionID == "" {
        c.JSON(http.StatusBadRequest, gin.H{
            "error": "session_id query parameter is required",
        })
        return
    }

    // Get session
    sess, err := h.manager.GetSession(sessionID)
    if err != nil {
        c.JSON(http.StatusNotFound, gin.H{
            "error": "Session not found",
            "details": err.Error(),
        })
        return
    }

    // Optional: Request summary from cursor-agent
    // TODO: Implement summary request in future enhancement
    var summary string

    // Close pipes
    if sess.Stdin != nil {
        if err := sess.Stdin.Close(); err != nil {
            fmt.Printf("Warning: failed to close stdin for session %s: %v\n", sessionID, err)
        }
    }
    if sess.Stdout != nil {
        if err := sess.Stdout.Close(); err != nil {
            fmt.Printf("Warning: failed to close stdout for session %s: %v\n", sessionID, err)
        }
    }

    // Terminate process
    if sess.Process != nil {
        // Try graceful shutdown first
        if err := sess.Process.Process.Signal(os.Interrupt); err != nil {
            // If interrupt fails, force kill
            if killErr := sess.Process.Process.Kill(); killErr != nil {
                fmt.Printf("Warning: failed to kill process for session %s: %v\n", sessionID, killErr)
            }
        }

        // Wait for process to exit (with timeout)
        done := make(chan error, 1)
        go func() {
            done <- sess.Process.Wait()
        }()

        select {
        case <-done:
            // Process exited
        case <-time.After(5 * time.Second):
            // Timeout, force kill
            sess.Process.Process.Kill()
            <-done // Wait for it to finish
        }
    }

    // Remove from manager
    if err := h.manager.EndSession(sessionID); err != nil {
        c.JSON(http.StatusInternalServerError, gin.H{
            "error": "Failed to remove session from manager",
            "details": err.Error(),
        })
        return
    }

    c.JSON(http.StatusOK, EndSessionResponse{
        Message:   "Session ended successfully",
        SessionID: sessionID,
        Summary:   summary,
    })
}
```

### 3. Update router
In `internal/api/router.go`:
```go
api.POST("/session/end", sessionHandler.EndSession)
```

## Test Plan

### Unit Tests
In `internal/api/handlers/session_test.go`:

1. **Test EndSession Success**:
   - Mock session with process
   - Verify pipes closed
   - Verify process terminated
   - Verify session removed from manager

2. **Test Missing session_id**:
   - Verify 400 response

3. **Test Session Not Found**:
   - Mock manager to return error
   - Verify 404 response

4. **Test Process Termination**:
   - Test graceful shutdown
   - Test force kill on timeout

### Integration Tests
Manual verification:

1. Create session
2. Ask a question (verify session working)
3. End session
4. Verify success response
5. Verify process no longer running (ps aux | grep cursor-agent)
6. Try to ask question to ended session
7. Verify 404 error
8. Test ending non-existent session
9. Test ending already-ended session

### Success Criteria
- [ ] Endpoint ends sessions successfully
- [ ] Pipes closed properly
- [ ] Process terminated gracefully
- [ ] Force kill works if graceful fails
- [ ] Session removed from manager
- [ ] Error handling for all edge cases
- [ ] No resource leaks
- [ ] Consistent JSON response format

## Verification

```bash
# Create session
SESSION_ID=$(curl -X POST http://localhost:3000/api/session/start | jq -r '.session_id')

# Check process running
ps aux | grep cursor-agent | grep -v grep
# Should see process

# End session
curl -X POST "http://localhost:3000/api/session/end?session_id=$SESSION_ID"

# Expected response:
# {"message":"Session ended successfully","session_id":"<uuid>"}

# Verify process gone
ps aux | grep cursor-agent | grep -v grep
# Should not see process for this session

# Try to use ended session
curl -X POST "http://localhost:3000/api/ask?session_id=$SESSION_ID" \
  -H "Content-Type: application/json" \
  -d '{"question":"test"}'
# Expected: 404 error

# Test ending non-existent session
curl -X POST "http://localhost:3000/api/session/end?session_id=invalid"
# Expected: 404 error
```

## Files Modified

### Modified Files
- `internal/api/handlers/session.go`
- `internal/api/router.go`
- `internal/api/handlers/session_test.go`



