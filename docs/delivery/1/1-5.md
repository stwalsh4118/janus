# [1-5] Implement POST /api/session/end endpoint

[Back to task list](./tasks.md)

## Description

Implement the session termination endpoint that removes the session from the in-memory session manager, cleaning up all session state.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-11 00:00:00 | Created | N/A | Proposed | Task file created | Sean |
| 2025-10-11 12:00:00 | Status Change | Proposed | InProgress | Starting implementation - simplified for CLI-based architecture | AI Agent |
| 2025-10-11 12:30:00 | Status Change | InProgress | Review | Implementation complete - EndSessionResponse added, End handler updated, tests passing | AI Agent |
| 2025-10-11 12:45:00 | Status Change | Review | Done | All tests passed, manual verification successful against running server | Sean |

## Requirements

1. Replace stub `POST /api/session/end?session_id={id}` endpoint
2. Validate session_id parameter
3. Retrieve session from SessionManager to verify it exists
4. Remove session from SessionManager (cleanup in-memory state)
5. Return success response with proper EndSessionResponse type
6. Handle errors:
   - Invalid/missing session_id
   - Session not found

**Note**: The current architecture uses cursor-agent as a CLI command per question (not a persistent process), so there are no pipes or processes to terminate. Session cleanup is simply removing the entry from the in-memory manager.

## Implementation Plan

### 1. Define EndSessionResponse type
In `internal/api/handlers/session.go`:

```go
type EndSessionResponse struct {
    Message   string `json:"message"`
    SessionID string `json:"session_id"`
}
```

### 2. Update End handler method
Replace the current stub implementation with proper response type and error handling:

```go
func (h *SessionHandler) End(c *gin.Context) {
    sessionID := c.Query("session_id")
    if sessionID == "" {
        c.JSON(http.StatusBadRequest, gin.H{
            "error": "session_id query parameter is required",
        })
        return
    }

    // Verify session exists
    _, err := h.sessionManager.GetSession(sessionID)
    if err != nil {
        c.JSON(http.StatusNotFound, gin.H{
            "error":   "Session not found",
            "details": err.Error(),
        })
        return
    }

    // Remove session from manager
    if err := h.sessionManager.EndSession(sessionID); err != nil {
        c.JSON(http.StatusInternalServerError, gin.H{
            "error":   "Failed to end session",
            "details": err.Error(),
        })
        return
    }

    log.Printf("Session %s ended successfully", sessionID)

    response := EndSessionResponse{
        Message:   "Session ended successfully",
        SessionID: sessionID,
    }

    c.JSON(http.StatusOK, response)
}
```

**Note**: Router already configured in `internal/api/router.go` with `api.POST("/session/end", sessionHandler.End)`

## Test Plan

### Unit Tests
In `internal/api/handlers/session_test.go`:

1. **Test EndSession Success**:
   - Create a session
   - Call End endpoint
   - Verify 200 response with EndSessionResponse structure
   - Verify session removed from manager

2. **Test Missing session_id**:
   - Call End without session_id parameter
   - Verify 400 response with error message

3. **Test Session Not Found**:
   - Call End with non-existent session_id
   - Verify 404 response with error message

4. **Test EndSession Idempotency**:
   - End session once successfully
   - Try to end same session again
   - Verify 404 response (session already removed)

### Integration Tests
Manual verification:

1. Create session via `/api/session/start`
2. Ask a question to verify session is active
3. End session via `/api/session/end`
4. Verify success response with proper structure
5. Try to ask question to ended session
6. Verify 404 error (session not found)
7. Test ending non-existent session
8. Verify 404 error

### Success Criteria
- [ ] Endpoint ends sessions successfully
- [ ] Session removed from manager (in-memory cleanup)
- [ ] Proper EndSessionResponse format returned
- [ ] Error handling for missing session_id (400)
- [ ] Error handling for non-existent session (404)
- [ ] Ended sessions cannot be used for subsequent requests
- [ ] Consistent JSON response format

## Verification

```bash
# Create session
SESSION_ID=$(curl -X POST http://localhost:3000/api/session/start | jq -r '.session_id')
echo "Created session: $SESSION_ID"

# End session
curl -X POST "http://localhost:3000/api/session/end?session_id=$SESSION_ID"

# Expected response:
# {"message":"Session ended successfully","session_id":"<uuid>"}

# Try to use ended session
curl -X POST "http://localhost:3000/api/ask?session_id=$SESSION_ID" \
  -H "Content-Type: application/json" \
  -d '{"question":"test"}'
# Expected: {"error":"Session not found","details":"session not found: <uuid>"}

# Test ending non-existent session
curl -X POST "http://localhost:3000/api/session/end?session_id=invalid-id"
# Expected: {"error":"Session not found","details":"session not found: invalid-id"}

# Test missing session_id
curl -X POST "http://localhost:3000/api/session/end"
# Expected: {"error":"session_id query parameter is required"}
```

## Files Modified

### Modified Files
- `internal/api/handlers/session.go` - Add EndSessionResponse type and update End() handler
- `internal/api/handlers/session_test.go` - Add unit tests for End endpoint



